<!doctype html>
<html lang="ko">
  <!-- Version: 1.6.1 (2025-09-24, Asia/Seoul) -->
  <!-- Changes:
       - Delete button fix: even when it's the last row, deletion works and a new blank row is created automatically.
       - Keeps v1.6 dimensional feasibility (inner size & door) and overfill notice features.
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KBRIDGE / CBM 계산기</title>
  <link rel="stylesheet" href="https://cdn.tradlinx.com/fonts/pretendard/pretendard-dynamic-subset.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
  --primary:#6d28d9;
  --primary-600:#5b21b6;
  --ring:#a78bfa;
}
body{background:var(--bg);color:var(--text);}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(16,24,40,.06);}
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:12px;border:1px solid transparent;background:linear-gradient(90deg,var(--primary),var(--primary-600));color:#fff;font-weight:700;letter-spacing:.01em;box-shadow:0 6px 20px rgba(109,40,217,.25);cursor:pointer; transition:all .15s ease;}
.btn:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(109,40,217,.35);} .btn:active{transform:translateY(0);}
.btn-ghost{background:transparent;color:var(--primary-600);border:1px solid #ead7ff;box-shadow:none;}
.btn-ghost:hover{background:rgba(167,139,250,.12);}
.input,.select{width:100%;max-width:8rem;appearance:none;background:#fff;border:1px solid var(--border);border-radius:10px;padding:.45rem .6rem;font-variant-numeric:tabular-nums;box-shadow:0 1px 0 rgba(16,24,40,.02);transition:border-color .15s ease, box-shadow .15s ease;}
.input:focus,.select:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 4px rgba(167,139,250,.15);}
.badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:9999px;border:1px solid #e9d5ff;background:#f5f3ff;color:#4c1d95;font-weight:700;font-size:.75rem;}
.rwd-wrap{overflow:auto;border:1px solid var(--border);border-radius:16px;background:var(--card);}
.rwd-table{width:100%;border-collapse:separate;border-spacing:0;}
.rwd-table thead th{position:sticky;top:0;z-index:5;background:linear-gradient(0deg,#fafaff,#fff);color:#475569;font-weight:700;border-bottom:1px solid var(--border);}
.rwd-table tbody tr{transition:background .12s ease;} .rwd-table tbody tr:hover{background:#faf5ff;}
.rwd-table tbody td{border-bottom:1px solid var(--border);}
.rwd-table .del .btn{background:#fee2e2;border:1px solid #fecaca;color:#b91c1c;box-shadow:none;font-weight:700;} .rwd-table .del .btn:hover{background:#fecaca;}
.gradient-card{background: radial-gradient(1200px 300px at 10% -10%, rgba(255,255,255,.15) 0%, rgba(255,255,255,0) 30%), linear-gradient(135deg, #6d28d9 0%, #4f46e5 55%, #22c55e 120%);color:#fff;border:0; position: relative; padding-bottom: 64px;}
.gradient-card .text-slate-600, .gradient-card .text-slate-500{color:rgba(255,255,255,.85)!important;}
.gradient-card .badge{border-color:rgba(255,255,255,.55); background:rgba(255,255,255,.12); color:#fff;}
.gradient-card .btn-ghost{color:#fff;border-color:rgba(255,255,255,.35);} .gradient-card .btn-ghost:hover{background:rgba(255,255,255,.12);}
@media (min-width:280px){ .rwd-table thead th, .rwd-table tbody td { padding:.5rem .75rem; } }
    /* Compact first six input columns + alignment */
    @media (min-width:280px) {
      .rwd-table { table-layout: fixed; }
      .rwd-table th:nth-child(1), .rwd-table td:nth-child(1) { width: 7rem; }
      .rwd-table th:nth-child(2), .rwd-table td:nth-child(2) { width: 7rem; }
      .rwd-table th:nth-child(3), .rwd-table td:nth-child(3) { width: 7rem; }
      .rwd-table th:nth-child(4), .rwd-table td:nth-child(4) { width: 6rem; }
      .rwd-table th:nth-child(5), .rwd-table td:nth-child(5) { width: 7rem; }
      .rwd-table th:nth-child(6), .rwd-table td:nth-child(6) { width: 6rem; }
      .rwd-table td:nth-child(-n+6) .input { max-width: 6.25rem; }
      .rwd-table td:nth-child(4) .select { max-width: 5.75rem; }
      .rwd-table th:nth-child(-n+6), .rwd-table td:nth-child(-n+6) { text-align: center; }
      .rwd-table th:nth-child(7), .rwd-table td:nth-child(7),
      .rwd-table th:nth-child(8), .rwd-table td:nth-child(8) { text-align: right; }
      .rwd-table th:nth-child(9), .rwd-table td:nth-child(9) { text-align: center; }
    }
    /* Center the container spec table (override all align) */
    .spec-table th, .spec-table td { text-align: center !important; }
  
/* kbridge-logo-position */
.gradient-card{position:relative;min-height:110px;}

.air-rule-toolbar{ position:absolute; right:16px; bottom:12px; }

@media (max-width: 480px){ .air-rule-toolbar{ right:12px; bottom:10px; } }

.header-subline{ position:absolute; left:16px; bottom:12px; margin:0 !important; }
@media (max-width:480px){ .header-subline{ left:12px; bottom:10px; font-size:.875rem; } }
</style>

<style>
/* KBridge logo placement */
.header .brand-logo{position:absolute; right:16px; top:10px; display:flex; align-items:center; gap:8px;}
.header .brand-logo img{width:280px; height:auto; max-height:63px; object-fit:contain;}
@media (max-width:280px){
  .header .brand-logo img{width:280px; max-height:63px;}
}
</style>
<style>
/* KBridge white logo above air volumetric weight rules */
.kbridge-logo-air{display:flex;justify-content:center;align-items:center;margin:12px 0 6px;}
.kbridge-logo-air img{max-width:280px;height:auto;object-fit:contain;opacity:0.95;}
@media (max-width:280px){.kbridge-logo-air img{max-width:280px;}}
</style>
<style id="mobile-optimizations">
/* === Mobile Size Optimizations (non-destructive) === */
/* Fluid base type scale for small screens */
html { font-size: clamp(14px, 3.2vw, 16px); }

@media (max-width: 640px){
  main { padding: 1rem !important; }
  .gradient-card { padding: 1rem !important; border-radius: 14px; }
  header h1 { font-size: clamp(1.125rem, 5vw, 1.375rem) !important; line-height: 1.25 !important; }
  .header-subline { font-size: .875rem !important; max-width: 92%; }
  .air-rule-toolbar { font-size: .75rem; gap: .375rem; }
  .badge { font-size: .6875rem; padding: .15rem .5rem; }
  .btn, .btn-ghost { padding: .5rem .7rem; border-radius: 10px; }
  .input, .select { max-width: 5.25rem !important; padding: .35rem .5rem; font-size: .875rem; }
  .rwd-wrap { -webkit-overflow-scrolling: touch; overflow-x: auto; }
  .rwd-table { table-layout: fixed; min-width: 660px; }
  .rwd-table th, .rwd-table td { padding: .4rem .5rem; }
  /* Narrower column widths to reduce horizontal scroll in mobile */
  .rwd-table th:nth-child(1), .rwd-table td:nth-child(1) { width: 5.5rem; }
  .rwd-table th:nth-child(2), .rwd-table td:nth-child(2) { width: 5.5rem; }
  .rwd-table th:nth-child(3), .rwd-table td:nth-child(3) { width: 5.5rem; }
  .rwd-table th:nth-child(4), .rwd-table td:nth-child(4) { width: 5.0rem; }
  .rwd-table th:nth-child(5), .rwd-table td:nth-child(5) { width: 5.25rem; }
  .rwd-table th:nth-child(6), .rwd-table td:nth-child(6) { width: 5.0rem; }
  .rwd-table th:nth-child(7), .rwd-table td:nth-child(7) { width: 5.5rem; }
  .rwd-table th:nth-child(8), .rwd-table td:nth-child(8) { width: 5.5rem; }
  .rwd-table th:nth-child(9), .rwd-table td:nth-child(9) { width: 4.5rem; }
  /* Brand/air logos scale down to avoid overlap */
  .header .brand-logo img, .kbridge-logo-air img { max-width: 160px !important; max-height: 40px !important; }
}

/* Ultra-small devices */
@media (max-width: 360px){
  .input, .select { max-width: 4.75rem !important; }
  .rwd-table { min-width: 620px; }
}

/* Optional: sticky first column for better readability on scroll */
@media (max-width: 640px){
  .rwd-table thead th:first-child, .rwd-table tbody td:first-child {
    position: sticky; left: 0;
    background: var(--card); z-index: 6;
    box-shadow: 1px 0 0 var(--border);
  }
}
</style>
<style>
/* ===== Mobile overlap fixes (hero badges & input header buttons) ===== */
@media (max-width: 480px){
  /* Hero subline & air-rule toolbar: prevent overlap with title */
  .header-subline{ position: static !important; margin-top: .25rem !important; }
  .air-rule-toolbar{
    position: static !important;
    display: flex !important;
    flex-wrap: wrap !important;
    gap: .375rem !important;
    margin-top: .25rem !important;
  }
  .air-rule-toolbar .badge{ flex: 0 0 auto; }
  .gradient-card{ min-height: 140px !important; }

  /* Input section header: let button group wrap below title */
  section.card > .mb-3.flex{
    flex-wrap: wrap !important;
    align-items: flex-start !important;
    gap: .5rem !important;
  }
  section.card > .mb-3.flex h2{ margin-right: auto !important; }
  section.card > .mb-3.flex > .flex{
    flex-wrap: wrap !important;
    gap: .5rem !important;
  }
}
</style>
<style>
/* ===== Responsive spec-table: show all fields at once on small screens ===== */
@media (max-width: 640px){
  /* Hide header row on mobile and turn each table row into a labeled block */
  .spec-table thead{ display:none; }
  .spec-table, .spec-table tbody, .spec-table tr, .spec-table td{ display:block; width:100%; }
  .spec-table tr{
    border:1px solid rgba(15,23,42,.08);
    border-radius:12px;
    padding:10px 12px;
    margin-bottom:10px;
    background:#fff;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
  }
  .spec-table td{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 0;
    border-bottom:1px dashed rgba(15,23,42,.08);
  }
  .spec-table td:last-child{ border-bottom:none; }

  /* Labels using nth-child to map header names */
  .spec-table td:nth-child(1)::before{ content:"Size & Type"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(2)::before{ content:"Height"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(3)::before{ content:"Tare (kg)"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(4)::before{ content:"Payload (kg)"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(5)::before{ content:"Max.Gross (kg)"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(6)::before{ content:"Door W×H (mm)"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(7)::before{ content:"내부 L×W×H (mm)"; font-weight:600; color:#334155; }
  .spec-table td:nth-child(8)::before{ content:"내부 용적 (m³)"; font-weight:600; color:#334155; }

  .spec-table td::before{
    content: attr(data-label);
    flex:0 0 46%;
    max-width:54%;
    padding-right:8px;
  }
  /* Value */
  .spec-table td{
    font-weight:600;
    color:#0f172a;
  }
}
</style>
</head>
<body class="min-h-full bg-slate-50">
  <!-- Tailwind dynamic class preflight (hidden element to ensure JIT includes classes used via JS) -->
  <div class="hidden bg-rose-500 ring-rose-200 text-rose-600 text-emerald-600"></div>

  <main class="mx-auto max-w-6xl p-6 md:p-10">
    <!-- Header -->
    <header class="mb-6 gradient-card rounded-2xl p-6 md:p-8 flex flex-col gap-4">

      <div>
        <h1 class="flex items-center gap-2 text-2xl md:text-3xl font-extrabold tracking-tight">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-7 w-7">
            <rect x="3.5" y="3" width="17" height="18" rx="2"></rect>
            <path d="M7 7h10M7 12h10M7 17h3"></path>
          </svg>
          CBM 계산기
        </h1>
        <p class="header-subline text-slate-100/85 text-sm md:text-base">컨테이너 적재 부피(CBM, m³)를 쉽고 정확하게 계산하세요. 여러 박스를 한 번에 입력할 수 있어요.</p>
      </div>
      <div class="air-rule-toolbar flex items-center gap-2 text-xs text-white/85">
        <span class="badge">항공 부피중량 규정</span>
        <label class="inline-flex items-center gap-1"><input class="air-factor" type="radio" name="airFactor" value="6000" checked> 6000</label>
        <label class="inline-flex items-center gap-1"><input class="air-factor" type="radio" name="airFactor" value="5000"> 5000</label>
      </div></header>

    <!-- Input Card -->
    <section class="card p-4 md:p-6">
      <div class="mb-3 flex items-center justify-between gap-2">
        <h2 class="text-base md:text-lg font-semibold">화물 정보 입력</h2>
        <div class="flex gap-2">
          <button id="addRowBtn" class="btn btn-ghost" type="button">+ 행 추가</button>
          <button id="clearAllBtn" class="btn btn-ghost" type="button">초기화</button>
        </div>
      </div>

      <div class="rwd-wrap">
        <table class="rwd-table text-sm">
          <thead>
            <tr class="border-b border-slate-200">
              <th class="py-2 pr-3">가로(L)</th>
              <th class="py-2 pr-3">세로(W)</th>
              <th class="py-2 pr-3">높이(H)</th>
              <th class="py-2 pr-3">단위</th>
              <th class="py-2 pr-3">중량(kg)</th>
              <th class="py-2 pr-3">수량</th>
              <th class="py-2 pr-3 text-right">개당 CBM</th>
              <th class="py-2 pr-3 text-right">합계 CBM</th>
              <th class="py-2">삭제</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-slate-500">Tip: 단위(mm/cm/m/inch)를 바꾸면 자동으로 CBM이 다시 계산됩니다. 입력값은 최종 포장 기준을 권장합니다.</p>
    </section>

    <!-- Summary Grid -->
    <section class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-4">
        <p class="text-xs text-slate-500">총 CBM</p>
        <p id="totalCbm" class="text-2xl font-bold tracking-tight">0</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">총 중량 (kg)</p>
        <p id="totalWeight" class="text-2xl font-bold tracking-tight">0</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">항공 부피중량 (kg)</p>
        <p id="airVol" class="text-2xl font-bold tracking-tight">0</p>
        <p class="text-[11px] text-slate-500">(Σ m³ × 1,000,000 ÷ <span id="airFactorLabel">6000</span>)</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">해상 톤측정 (kg)</p>
        <p id="seaWm" class="text-2xl font-bold tracking-tight">0</p>
        <p class="text-[11px] text-slate-500">(Σ m³ × 1000)</p>
      </div>
    </section>

    <!-- Utilization -->
    <section class="mt-6 card p-4 md:p-6">
      <h2 class="text-base md:text-lg font-semibold mb-4">컨테이너 용적 대비 적재율</h2>
      <div id="containerCards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <!-- Specs (centered) -->
    <section class="mt-6 card p-4 md:p-6">
      <h2 class="text-base md:text-lg font-semibold mb-3 text-center">컨테이너 규격</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm spec-table">
          <thead class="border-b border-slate-200">
            <tr>
              <th class="py-2 pr-3">Size &amp; Type</th>
              <th class="py-2 pr-3">Height</th>
              <th class="py-2 pr-3">Tare (kg)</th>
              <th class="py-2 pr-3">Payload (kg)</th>
              <th class="py-2 pr-3">Max.Gross (kg)</th>
              <th class="py-2 pr-3">Door W×H (mm)</th>
              <th class="py-2 pr-3">내부 L×W×H (mm)</th>
              <th class="py-2">내부 용적 (m³)</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b last:border-0">
              <td class="py-2">20'FT</td>
              <td class="py-2">8'6"</td>
              <td class="py-2">2,200</td>
              <td class="py-2">28,280</td>
              <td class="py-2">30,480</td>
              <td class="py-2">2,340 × 2,280</td>
              <td class="py-2">5,898 × 2,352 × 2,392</td>
              <td class="py-2">33.2</td>
            </tr>
            <tr class="border-b last:border-0">
              <td class="py-2">40'FT</td>
              <td class="py-2">8'6"</td>
              <td class="py-2">3,600</td>
              <td class="py-2">28,900</td>
              <td class="py-2">32,500</td>
              <td class="py-2">2,340 × 2,280</td>
              <td class="py-2">12,032 × 2,352 × 2,392</td>
              <td class="py-2">67.6</td>
            </tr>
            <tr>
              <td class="py-2">40'HC</td>
              <td class="py-2">9'6"</td>
              <td class="py-2">3,800</td>
              <td class="py-2">28,700</td>
              <td class="py-2">32,500</td>
              <td class="py-2">2,340 × 2,585</td>
              <td class="py-2">12,032 × 2,352 × 2,698</td>
              <td class="py-2">76.3</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">© <span id="year"></span> CBM Calculator UI v1.6.1 • Made by KBRIDGE</footer>
  </main>

<script>
(function(){
  const UNIT_TO_M = { mm: 0.001, cm: 0.01, m: 1, inch: 0.0254 };
  const format = (n, d=3) => Number(n).toLocaleString(undefined, { maximumFractionDigits: d });
  const clampPos = (v) => isNaN(v) || v < 0 ? 0 : v;

  const rowsTbody = document.getElementById('rows');
  const addRowBtn = document.getElementById('addRowBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const totalCbmEl = document.getElementById('totalCbm');
  const totalWeightEl = document.getElementById('totalWeight');
  const airVolEl = document.getElementById('airVol');
  const seaWmEl = document.getElementById('seaWm');
  const airFactorLabel = document.getElementById('airFactorLabel');
  const yearEl = document.getElementById('year');
  yearEl.textContent = new Date().getFullYear();

  let airDimFactor = 6000; // default
  document.querySelectorAll('.air-factor').forEach(r => {
    r.addEventListener('change', (e)=>{
      airDimFactor = Number(e.target.value);
      airFactorLabel.textContent = airDimFactor;
      compute();
    });
  });

  const CONTAINERS = [
    { name: "20'FT", cubic: 33.2 },
    { name: "40'FT", cubic: 67.6 },
    { name: "40'HC", cubic: 76.3 },
  ];

  const CONTAINER_SPECS = [
    { inner: [5898, 2352, 2392], door: [2340, 2280] }, // 20FT
    { inner: [12032, 2352, 2392], door: [2340, 2280] }, // 40FT
    { inner: [12032, 2352, 2698], door: [2340, 2585] }, // 40HC
  ];

  const containerCardsWrap = document.getElementById('containerCards');
  const containerBars = [];
  CONTAINERS.forEach((c, idx)=>{
    const card = document.createElement('div');
    card.className = 'p-4 rounded-2xl ring-1 ring-slate-200 bg-white shadow-sm';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">${c.name}</div>
        <div class="text-xs text-slate-500">용적 ${c.cubic} m³</div>
      </div>
      <div class="mt-3 h-3 w-full rounded-full bg-slate-100 overflow-hidden">
        <div class="h-3 w-0 rounded-full bg-sky-500 transition-all" id="bar-${idx}"></div>
      </div>
      <div class="mt-2 text-sm"><span id="label-${idx}">0 / ${c.cubic} m³ (0%)</span></div>
      <div class="mt-1 text-xs hidden" id="note-${idx}"></div>
      <div class="mt-1 text-xs hidden" id="fit-${idx}"></div>
    `;
    containerCardsWrap.appendChild(card);
    containerBars.push({
      capacity: c.cubic,
      bar: card.querySelector('#bar-'+idx),
      label: card.querySelector('#label-'+idx),
      note: card.querySelector('#note-'+idx),
      fit: card.querySelector('#fit-'+idx),
      card
    });
  });

  function createRow(values){
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 last:border-0';
    tr.innerHTML = `
      <td class="py-2 pr-3" data-label="가로(L)"><input type="number" inputmode="decimal" step="0.01" min="0" class="input" placeholder="0" aria-label="길이(L)"></td>
      <td class="py-2 pr-3" data-label="세로(W)"><input type="number" inputmode="decimal" step="0.01" min="0" class="input" placeholder="0" aria-label="세로(W)"></td>
      <td class="py-2 pr-3" data-label="높이(H)"><input type="number" inputmode="decimal" step="0.01" min="0" class="input" placeholder="0" aria-label="높이(H)"></td>
      <td class="py-2 pr-3" data-label="단위">
        <select class="select" aria-label="단위">
          <option value="mm">mm</option>
          <option value="cm" selected>cm</option>
          <option value="m">m</option>
          <option value="inch">inch</option>
        </select>
      </td>
      <td class="py-2 pr-3" data-label="중량(kg)"><input type="number" inputmode="decimal" step="0.01" min="0" class="input" placeholder="0" aria-label="중량(kg)"></td>
      <td class="py-2 pr-3" data-label="수량"><input type="number" inputmode="numeric" step="1" min="0" value="1" class="input" aria-label="수량"></td>
      <td class="py-2 pr-3 text-right font-mono tabular-nums" data-label="개당 CBM">0</td>
      <td class="py-2 pr-3 text-right font-mono tabular-nums" data-label="합계 CBM">0</td>
      <td class="py-2 del" data-label="삭제"><button type="button" class="btn btn-ghost text-slate-600 w-full sm:w-auto">삭제</button></td>
    `;

    const [lenI, widI, heiI] = tr.querySelectorAll('input');
    const unitS = tr.querySelector('select');
    const weightI = tr.querySelectorAll('input')[3];
    const qtyI = tr.querySelectorAll('input')[4];
    const perCell = tr.children[6];
    const totCell = tr.children[7];
    const delBtn = tr.querySelector('button');

    if(values){
      lenI.value = values.length ?? '';
      widI.value = values.width ?? '';
      heiI.value = values.height ?? '';
      unitS.value = values.unit ?? 'cm';
      weightI.value = values.weight ?? '';
      qtyI.value = values.qty ?? 1;
    }

    const onAny = () => compute();
    [lenI, widI, heiI, weightI, qtyI].forEach(i => i.addEventListener('input', onAny));
    unitS.addEventListener('change', onAny);

    // FIX: allow deleting the last row by recreating a fresh blank row
    delBtn.addEventListener('click', ()=>{
      tr.remove();
      if (rowsTbody.children.length === 0) {
        createRow();
      }
      compute();
    });

    rowsTbody.appendChild(tr);
    return tr;
  }

  function rowValues(tr){
    const inputs = tr.querySelectorAll('input');
    const unit = tr.querySelector('select').value;
    const L = clampPos(parseFloat(inputs[0].value));
    const W = clampPos(parseFloat(inputs[1].value));
    const H = clampPos(parseFloat(inputs[2].value));
    const weight = clampPos(parseFloat(inputs[3].value));
    const qty = clampPos(parseInt(inputs[4].value||'0', 10));
    return { L, W, H, unit, weight, qty };
  }

  // Dimensional utilities (same as v1.6)
  function canFitInner(inner, dims){
    const p = [[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]];
    for(const perm of p){
      if(dims[perm[0]] <= inner[0] && dims[perm[1]] <= inner[1] && dims[perm[2]] <= inner[2]) return true;
    }
    return false;
  }
  function canPassDoor(door, dims){
    const pairs = [[0,1],[0,2],[1,2]];
    for(const [i,j] of pairs){
      const a = dims[i], b = dims[j];
      if( (a <= door[0] && b <= door[1]) || (a <= door[1] && b <= door[0]) ) return true;
    }
    return false;
  }
  function mm(val, unit){ return (val || 0) * (UNIT_TO_M[unit] || 0) * 1000; } // to mm

  function compute(){
    let totalM3 = 0, totalKg = 0;

    const boxes = [];
    [...rowsTbody.children].forEach(tr => {
      const { L, W, H, unit, weight, qty } = rowValues(tr);
      const f = UNIT_TO_M[unit] || 0;
      const perM3 = (L*f) * (W*f) * (H*f);
      const lineM3 = perM3 * (qty || 0);

      tr.children[6].textContent = format(perM3, 4);
      tr.children[7].textContent = format(lineM3, 4);

      totalM3 += lineM3;
      totalKg += (weight || 0) * (qty || 0);

      if (qty > 0 && (L>0 && W>0 && H>0)) {
        boxes.push([mm(L,unit), mm(W,unit), mm(H,unit)]);
      }
    });

    totalCbmEl.textContent = format(totalM3, 4);
    totalWeightEl.textContent = format(totalKg, 1);

    const airVol = (totalM3 * 1_000_000) / (airDimFactor || 6000);
    const seaWm = totalM3 * 1000;

    airVolEl.textContent = format(airVol, 1);
    seaWmEl.textContent = format(seaWm, 1);

    containerBars.forEach(({capacity, bar, label, note, fit, card}, idx)=>{
      const pctRaw = capacity > 0 ? (totalM3 / capacity) * 100 : 0;
      const pctClamped = Math.min(100, Math.max(0, pctRaw));
      bar.style.width = pctClamped + '%';

      const overM3 = Math.max(0, totalM3 - capacity);

      const spec = CONTAINER_SPECS[idx];
      let failInner = false, failDoor = false;
      for(const dims of boxes){
        if(!canFitInner(spec.inner, dims)) { failInner = true; break; }
        if(!canPassDoor(spec.door, dims)) { failDoor = true; }
      }

      if (overM3 > 0 || failInner || failDoor) {
        bar.classList.remove('bg-sky-500');
        bar.classList.add('bg-rose-500');
        card.classList.add('ring-rose-200');
      } else {
        bar.classList.remove('bg-rose-500');
        bar.classList.add('bg-sky-500');
        card.classList.remove('ring-rose-200');
      }

      const base = `${format(totalM3, 3)} / ${capacity} m³ (${format(pctRaw, 1)}%)`;
      label.textContent = overM3 > 0 ? `${base} • 초과 ${format(overM3, 3)} m³` : base;

      if (capacity > 0) {
        const needed = Math.max(1, Math.ceil(totalM3 / capacity));
        if (needed > 1) {
          const lastFill = totalM3 - capacity * (needed - 1);
          const lastPct = Math.min(100, (lastFill / capacity) * 100);
          note.classList.remove('hidden');
          note.classList.add('text-rose-600');
          note.innerHTML = `컨테이너 추가 필요 • 최소 <b>${needed}</b>대 권장 (마지막 컨테이너 예상 적재: ${format(lastFill, 3)} m³, ${format(lastPct, 1)}%)`;
        } else {
          note.classList.add('hidden');
          note.textContent = '';
        }
      }

      if (failInner || failDoor) {
        fit.classList.remove('hidden');
        fit.classList.add('text-rose-600');
        if (failInner && failDoor) {
          fit.textContent = '사이즈 초과: 내부치수 및 도어 통과 불가';
        } else if (failInner) {
          fit.textContent = '사이즈 초과: 내부치수 불가';
        } else if (failDoor) {
          fit.textContent = '도어 통과 불가';
        }
      } else {
        fit.classList.add('hidden');
        fit.textContent = '';
      }

    });
  }

  addRowBtn.addEventListener('click', ()=>{ createRow(); compute(); });
  clearAllBtn.addEventListener('click', ()=>{
    rowsTbody.innerHTML = '';
    createRow();
    compute();
  });

  // Init
  createRow();
  compute();
})();
</script>
</body>
</html>
